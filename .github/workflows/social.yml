name: Social
on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  bluesky:
    runs-on: ubuntu-latest
    steps:
      - name: Install Node ‚¨áÔ∏è
        uses: actions/setup-node@64ed1c7eab4cce3362f8c340dee64e5eaeef8f7c
        with:
          node-version: 18
      - name: Install dependencies üì¶
        run: npm install @atproto/api node-fetch
      - name: Skeet üå§Ô∏è
        id: bluesky
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410
        with:
          script: |
            const { BskyAgent } = require("@atproto/api");
            // not including this makes atproto/api fail on posting
            // const fetch = require("node-fetch");

            let release = context.payload.release;

            if (release === null || release === undefined) {
                console.log("No release data found, fetching latest release")
                const response = await github.rest.repos.getLatestRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                });
                release = response.data;
            }

            let notes = release.body;

            // replace all non-supported characters
            notes = notes.replaceAll('###', '');
            notes = notes.replaceAll('**', '');
            notes = notes.replace(/ \(\[[0-9a-z]+\]\(.*\)/g, '');
            notes = notes.trim();

            const agent = new BskyAgent({ service: 'https://bsky.social' });
            await agent.login({identifier: '${{ secrets.BLUESKY_IDENTIFIER }}', password: '${{ secrets.BLUESKY_PASSWORD }}'});

            const version = release.name;

                                const text = `üì¶ ${version}

                                ${notes}

                                #ohmyposh #oss #cli #opensource`;

            console.log(`Posting to Bluesky:\n\n${text}`);

            await agent.post({
                text: text,
                embed: {
                    $type: 'app.bsky.embed.external',
                    external: {
                        uri: `https://github.com/JanDeDobbeleer/oh-my-posh/releases/tag/${version}`,
                        title: "The best release yet üöÄ",
                        description: version,
                    },
                },
            });
